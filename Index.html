<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interrogazioni Classe - Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
    
    .pulse-alert { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from {transform: translateX(-20px); opacity: 0;} to {transform: translateX(0); opacity: 1;} }
</style>
</head>
<body class="bg-gradient-to-r from-purple-100 via-pink-100 to-yellow-100 min-h-screen p-4 sm:p-6 font-sans">

<div class="max-w-6xl mx-auto">
    <div class="text-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-purple-700 drop-shadow-lg mb-2">üìö Interrogazioni Classe</h1>
        <p class="text-sm text-gray-600" id="lastUpdate">Ultimo aggiornamento: caricamento...</p>
    </div>

    <!-- Form aggiungi studente -->
    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6">
        <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
            <input id="name" type="text" placeholder="Nome studente" autocomplete="off"
                class="flex-1 p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
            
            <input id="date" type="date"
                class="p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
            
            <select id="subjectSelect" class="p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
                <option value="">Seleziona materia...</option>
            </select>
            
            <button onclick="addStudent()" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition flex items-center justify-center gap-2 font-medium">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> 
                <span>Salva</span>
            </button>
        </div>
        
        <!-- Quick date buttons -->
        <div class="flex gap-2 mt-3 flex-wrap">
            <button onclick="setToday()" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200 transition">
                Oggi
            </button>
            <button onclick="setYesterday()" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200 transition">
                Ieri
            </button>
            <button onclick="setLastWeek()" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200 transition">
                Settimana scorsa
            </button>
        </div>
    </div>

    <!-- Stats rapide -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <div class="text-2xl font-bold text-purple-600" id="totalStudents">0</div>
            <div class="text-xs text-gray-600">Studenti totali</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <div class="text-2xl font-bold text-orange-600" id="alertCount">0</div>
            <div class="text-xs text-gray-600">Da interrogare</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <div class="text-2xl font-bold text-green-600" id="recentCount">0</div>
            <div class="text-xs text-gray-600">Recenti (&lt;14g)</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <div class="text-2xl font-bold text-blue-600" id="subjectCount">0</div>
            <div class="text-xs text-gray-600">Materie attive</div>
        </div>
    </div>

    <!-- Dashboard materie dinamiche -->
    <div id="subjectsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
    </div>
    
    <!-- Empty state -->
    <div id="emptyState" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">üìñ</div>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">Nessuno studente ancora</h3>
        <p class="text-gray-500">Aggiungi il primo studente per iniziare!</p>
    </div>
</div>

<script>
let subjectColors = {};
let allStudents = [];

// Utility per formattare la data
function formatDate(dateString) {
    const d = new Date(dateString);
    return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

// Calcola giorni dall'ultima interrogazione
function daysSince(dateString) {
    const then = new Date(dateString);
    const now = new Date();
    then.setHours(0, 0, 0, 0);
    now.setHours(0, 0, 0, 0);
    const diffTime = now - then;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}

// Hex to RGB
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

// Carica materie con colori dal database
async function loadSubjects() {
    try {
        const res = await fetch('/.netlify/functions/get-subjects');
        const subjects = await res.json();
        
        subjectColors = {};
        const select = document.getElementById('subjectSelect');
        select.innerHTML = '<option value="">Seleziona materia...</option>';
        
        subjects.forEach(s => {
            subjectColors[s.name] = s.color;
            const option = document.createElement('option');
            option.value = s.name;
            option.textContent = s.name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Errore caricamento materie:', error);
    }
}

// Aggiorna statistiche
function updateStats() {
    const total = allStudents.length;
    const alerts = allStudents.filter(s => daysSince(s.last_interrogation) > 14).length;
    const recent = allStudents.filter(s => daysSince(s.last_interrogation) <= 14).length;
    const subjects = new Set(allStudents.map(s => s.subject)).size;
    
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('alertCount').textContent = alerts;
    document.getElementById('recentCount').textContent = recent;
    document.getElementById('subjectCount').textContent = subjects;
    
    // Aggiorna timestamp
    const now = new Date();
    document.getElementById('lastUpdate').textContent = 
        `Ultimo aggiornamento: ${now.toLocaleTimeString('it-IT')}`;
}

// Fetch studenti dal server
async function fetchStudents() {
    try {
        const res = await fetch('/.netlify/functions/get-students');
        allStudents = await res.json();
        
        // Mostra empty state se vuoto
        const emptyState = document.getElementById('emptyState');
        const container = document.getElementById('subjectsContainer');
        
        if (allStudents.length === 0) {
            emptyState.classList.remove('hidden');
            container.innerHTML = '';
            updateStats();
            return;
        }
        
        emptyState.classList.add('hidden');
        
        // Raggruppa per materia
        const bySubject = {};
        allStudents.forEach(s => {
            if (!bySubject[s.subject]) {
                bySubject[s.subject] = [];
            }
            bySubject[s.subject].push(s);
        });
        
        // Ordina studenti per giorni dall'ultima interrogazione (pi√π vecchi prima)
        Object.keys(bySubject).forEach(subject => {
            bySubject[subject].sort((a, b) => 
                daysSince(b.last_interrogation) - daysSince(a.last_interrogation)
            );
        });
        
        // Render materie
        container.innerHTML = '';
        
        Object.keys(bySubject).sort().forEach(subject => {
            const color = subjectColors[subject] || '#6b7280';
            const rgb = hexToRgb(color);
            const lightColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15)`;
            
            const div = document.createElement('div');
            div.className = 'fade-in';
            
            const studentsInSubject = bySubject[subject];
            const urgentCount = studentsInSubject.filter(s => daysSince(s.last_interrogation) > 30).length;
            
            div.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-4 h-full">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-xl sm:text-2xl font-semibold flex items-center gap-2" style="color: ${color}">
                            <i data-lucide="book-open" class="w-5 h-5"></i> 
                            <span>${subject}</span>
                        </h2>
                        <span class="text-sm font-medium px-2 py-1 rounded-full bg-gray-100 text-gray-700">
                            ${studentsInSubject.length}
                        </span>
                    </div>
                    ${urgentCount > 0 ? `
                        <div class="bg-red-50 border border-red-200 text-red-700 text-xs px-3 py-1 rounded-lg mb-3 flex items-center gap-1">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                            ${urgentCount} da interrogare urgentemente
                        </div>
                    ` : ''}
                    <ul class="space-y-2" id="list-${subject}"></ul>
                </div>
            `;
            container.appendChild(div);
            
            const list = document.getElementById(`list-${subject}`);
            studentsInSubject.forEach((s, index) => {
                const days = daysSince(s.last_interrogation);
                const isOld = days > 14;
                const isVeryOld = days > 30;
                
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-lg shadow-sm slide-in ${isVeryOld ? 'pulse-alert' : ''}`;
                li.style.background = lightColor;
                li.style.borderLeft = `4px solid ${color}`;
                li.style.animationDelay = `${index * 0.05}s`;
                
                let badge = '';
                if (isVeryOld) {
                    badge = `<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold whitespace-nowrap">üî• ${days}g</span>`;
                } else if (isOld) {
                    badge = `<span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-bold whitespace-nowrap">‚ö†Ô∏è ${days}g</span>`;
                } else {
                    badge = `<span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full whitespace-nowrap">${days}g</span>`;
                }
                
                li.innerHTML = `
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="font-medium text-sm sm:text-base">${s.name}</span>
                        <span class="text-xs text-gray-600">${formatDate(s.last_interrogation)}</span>
                        ${badge}
                    </div>
                    <button onclick="deleteStudent(${s.id})" class="text-red-500 hover:text-red-700 transition ml-2 flex-shrink-0" title="Elimina">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(li);
            });
        });
        
        lucide.createIcons();
        updateStats();
        
    } catch (error) {
        console.error('Errore caricamento studenti:', error);
    }
}

// Aggiungi studente
async function addStudent() {
    const name = document.getElementById('name').value.trim();
    const date = document.getElementById('date').value;
    const subject = document.getElementById('subjectSelect').value;
    
    if(!name) {
        alert("Inserisci il nome dello studente!");
        document.getElementById('name').focus();
        return;
    }
    if(!date) {
        alert("Seleziona una data!");
        document.getElementById('date').focus();
        return;
    }
    if(!subject) {
        alert("Seleziona una materia!");
        document.getElementById('subjectSelect').focus();
        return;
    }
    
    try {
        await fetch('/.netlify/functions/add-student', {
            method: 'POST',
            body: JSON.stringify({ name, last_interrogation: date, subject })
        });
        
        document.getElementById('name').value = '';
        document.getElementById('subjectSelect').value = '';
        document.getElementById('name').focus();
        
        await fetchStudents();
    } catch (error) {
        alert('Errore durante il salvataggio. Riprova!');
        console.error(error);
    }
}

// Cancella studente
async function deleteStudent(id) {
    if(!confirm("Sei sicuro di voler cancellare questo studente?")) return;
    
    try {
        await fetch('/.netlify/functions/delete-student', {
            method: 'POST',
            body: JSON.stringify({ id })
        });
        await fetchStudents();
    } catch (error) {
        alert('Errore durante la cancellazione. Riprova!');
        console.error(error);
    }
}

// Quick date setters
function setToday() {
    document.getElementById('date').valueAsDate = new Date();
}

function setYesterday() {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    document.getElementById('date').valueAsDate = yesterday;
}

function setLastWeek() {
    const lastWeek = new Date();
    lastWeek.setDate(lastWeek.getDate() - 7);
    document.getElementById('date').valueAsDate = lastWeek;
}

// Enter key per salvare
document.getElementById('name').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addStudent();
});

// Imposta data di oggi come default
setToday();

// Carica tutto all'avvio
async function init() {
    await loadSubjects();
    await fetchStudents();
}

init();

// Aggiorna automaticamente ogni 30 secondi
setInterval(fetchStudents, 30000);

</script>

</body>
</html>